\begin{figure}
  \begin{minipage}[t]{0.50\textwidth}
    \centering
    \resizebox*{1.0\textwidth}{!}{\includegraphics{figures/happy-v4-v6-compete-0ms}}
  \end{minipage}
  \begin{minipage}[t]{0.50\textwidth}
    \centering
    \resizebox*{1.0\textwidth}{!}{\includegraphics{figures/happy-v4-v6-compete-300ms}}
  \end{minipage}
\caption{\label{fig:happy-v4-v6-compete}IPv4 and IPv6 Happy Eyeball Competition}
\end{figure}

A dual-stacked user when attempting to connect to a dual-stacked service
traditionally prefers connecting over IPv6. This is because in POSIX systems,
the internal domain name resolution system call \texttt{getaddrinfo(\ldots)}
\cite{rfc3493} returns the list of addresses in an order that prioritizes an
IPv6-upgrade path \cite{rfc6724}. The dictated order can dramatically reduce
the application responsiveness in situations where IPv6 connectivity is
broken. This is because, the attempt to connect over an IPv4 address will take
place only when the IPv6 connection attempt has timed out, which can be in the
order of seconds.

This noticeable degraded user experience can be subverted by making
applications apply the happy eyeballs algorithm \cite{rfc6555}. The algorithm
recommends that a dual-stacked application try resolving a dual-stacked
service for both IPv4 and IPv6 addresses at once. If the resolver returns both
addresses, the application must try a TCP \texttt{connect(\ldots)} to both the
resolved addresses and pick the one that completes first.

In this pursuit, to determine whether applications will use IPv4 or IPv6 on a
dual stacked service, we developed \texttt{happy}, a simple TCP happy eyeballs
probing tool. It uses non-blocking \texttt{connect(\ldots)} calls to establish
concurrent connections to a number of possible endpoints of a service. The
tool, however, does not check whether the endpoints of a given target all
provide the same service. Hence, it is possible to impact the results by
setting up fake servers that do not provide the service tested and which are
designed and deployed with the only purpose to provide fast connection setup
times.

We have cross-compiled \texttt{happy} for the OpenWRT
\footnote{\url{https://openwrt.org}} platform. As a result, the tool can now
be run on widely deployed SamKnows probes
\footnote{\url{http://www.samknows.com}}, and the collected measurement data
can be further analysed. In order to ascertain the value in this exercise, we
prepared an internal test-bed of multiple measurement points. The measurement
points have different flavors of IPv4 and IPv6 connectivity ranging from
native IPv4, native IPv6, IPv6 tunnel broker endpoints \cite{rfc3053}, Teredo
\cite{rfc4380} and tunnelled IPv4. We used the top 100 domains compiled by
Hurricane Electric Internet Services
\footnote{\url{http://bgp.he.net/ipv6-progress-report.cgi}} and ran
\texttt{happy} on the set of dual-stack services represented by these domains.

\begin{figure}
  \begin{minipage}[t]{0.50\textwidth}
    \centering
    \resizebox*{1.0\textwidth}{!}{\includegraphics{figures/happy-v4cloud}}
  \end{minipage}
  \begin{minipage}[t]{0.50\textwidth}
    \centering
    \resizebox*{1.0\textwidth}{!}{\includegraphics{figures/happy-v6cloud}}
  \end{minipage}
\caption{\label{fig:v4-v6-cloud}IPv4 and IPv6 aggregation cloud}
\end{figure}

A preliminary result comparing the preference of a happy-eyeballed application
to IPv6 and IPv4 from one of our measurement points is shown in Fig.
\ref{fig:happy-v4-v6-compete}. The measurement point represented in this plot
is located at Braunschweig and has a native IPv4 and a IPv6 connection through
the German Research Network \footnote{\url{http://www.dfn.de}}. The initial
results show that happy eyeballs prevents IPv6 access to Facebook, with only a
20\% chance to get to Google related services over IPv6. The plot looks very
different if IPv6 endpoints are allowed a 300ms chance to succeed, but even
then it appears the application will prefer to use IPv4 when reaching more
popular web services. In addition, it appears, some of the related (and few of
the unrelated) services show similar preferences. These services either
resolve to the same endpoint or a set of endpoints that belong to an allocated
block.  Digging through the \texttt{whois} information for each of the
endpoints from their \ac{RIR} seems to indicate that major portion of the
services map to a cloud of an address block owned by popular organizations
like Google and Akamai Technologies as shown in Fig.  \ref{fig:v4-v6-cloud}.

%As much as it is important to define and implement new tests on these
%measurement infrastructure, it is also equally pertinent to not only be able
%to install, update and delete these tests but also configure the entire suite
%of probes using a standardized protocol over the network. The \ac{NETCONF}
%protocol \cite{rfc6241} is particularly designed to cater to this problem.
%Towards this end, we have built a \ac{NETCONF} server for the OpenWRT platform
%using the \texttt{libnetconf}
%\footnote{\url{http://code.google.com/p/libnetconf/}} library and tested the
%implementation using our NETCONF Python API \texttt{ncclient}
%\cite{sbhushan:2009}. This will allow automated deployment of measurement
%tests and remote management of their startup configurations.

